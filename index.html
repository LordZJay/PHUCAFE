<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phu CafÃ© & Tea Digital Menu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e0f2f1; /* Light mint/teal background to match brand */
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
        }
        .menu-item {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .menu-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        /* Custom Phu Cafe Green */
        .phu-green-bg {
            background-color: #008060; /* A dark, rich green */
        }
        .phu-green-text {
            color: #008060;
        }
        .phu-green-border {
            border-color: #008060;
        }
        .phu-light-green-bg {
            background-color: #E0F2F1; /* Lighter shade for accents */
        }
        .phu-dark-text {
            color: #2c3e50; /* Darker text for readability */
        }
        /* Status Classes */
        .status-pending {
            background-color: #fffbe6;
            color: #d97706;
            border-color: #fcd34d;
        }
        .status-approved {
            background-color: #ecfdf5;
            color: #059669;
            border-color: #34d399;
        }
        .status-rejected {
            background-color: #fee2e2;
            color: #ef4444;
            border-color: #f87171;
        }
    </style>
</head>
<body>

    <div id="app" class="container mx-auto p-4 md:p-8">

        <!-- Header -->
        <header class="text-center mb-8 phu-green-bg p-6 rounded-xl shadow-lg">
            <h1 class="text-5xl font-extrabold text-white tracking-tight">Phu CafÃ© & Tea</h1>
            <p class="text-xl text-white mt-2">Digital Menu & Order System</p>
        </header>

        <!-- Status Message -->
        <div id="status-message-container" class="mb-6 rounded-lg p-4 bg-red-100 border-l-4 border-red-500 text-red-700" role="alert">
            <p class="font-bold">ðŸ”´ Database Status</p>
            <p id="status-message">Initializing database...</p>
        </div>

        <div id="main-content">
            <!-- Content will be rendered here -->
        </div>

        <!-- Modal -->
        <div id="modal-container" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div id="modal-content" class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
                <!-- Modal content will be dynamically loaded -->
            </div>
        </div>

    </div>

    <!-- Firebase and App Logic -->
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, setDoc, deleteDoc, onSnapshot, collection, query, orderBy, limit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-analytics.js"; 
        
        // --- MANDATORY GLOBAL VARIABLES (PROVIDED BY CANVAS) ---
        // Your web app's Firebase configuration - THIS IS CORRECT!
        const firebaseConfig = {
            apiKey: "AIzaSyDeSj66z4eXOaS-8AoLSizt141zbszmQzg",
            authDomain: "phucafe-1e238.firebaseapp.com",
            projectId: "phucafe-1e238",
            storageBucket: "phucafe-1e238.appspot.com",
            messagingSenderId: "861905109853",
            appId: "1:861905109853:web:207d6e58b92c20db4c1eb4",
            measurementId: "G-98KHVNL0F5" 
        };

        const appId = firebaseConfig.appId; 
        const initialAuthToken = null; 
        
        // --- APP CONFIGURATION ---
        const ADMIN_PASSWORD = 'ADMIN123'; 
        const IS_PERSISTENCE_ENABLED = firebaseConfig && firebaseConfig.apiKey && firebaseConfig.appId; 
        
        // --- IMAGE FALLBACK UTILITY ---
        const getPlaceholderImageUrl = (itemName) => {
            const text = itemName.slice(0, 3).toUpperCase().replace(/\s/g, '');
            return `https://placehold.co/80x80/008060/FFFFFF?text=${text}`;
        };

        // --- GLOBAL STATE ---
        let app = null;
        let db = null;
        let auth = null;
        let userId = null;
        let menuItems = [];
        let orders = [];
        let userCart = JSON.parse(localStorage.getItem('userCart')) || {};
        let isAdmin = false;
        let editingItemId = null; 

        // --- FIRESTORE HELPERS ---
        
        const getCollectionPath = (collectionName) => {
            return `artifacts/${appId}/public/data/${collectionName}`;
        };

        const getMenuCollection = () => collection(db, getCollectionPath('menu'));
        const getOrdersCollection = () => collection(db, getCollectionPath('orders'));
        
        // --- INITIALIZATION ---

        const fallbackToNonPersistentMode = () => {
            userId = crypto.randomUUID(); 
            loadDefaultData();
            renderApp(); 
            updateStatusMessage();
        };

        const updateStatusMessage = () => {
            const statusMessageElement = document.getElementById('status-message');
            const statusContainer = document.getElementById('status-message-container');

            if (statusMessageElement && statusContainer) {
                statusMessageElement.textContent = IS_PERSISTENCE_ENABLED 
                    ? 'âœ… Database Enabled: Menu edits and orders will be saved and real-time.'
                    : 'ðŸ”´ Database Disabled: Orders and Menu edits will NOT be saved. Showing default menu and orders will only persist in your current session.';

                statusContainer.className = IS_PERSISTENCE_ENABLED
                    ? "mb-6 rounded-lg p-4 bg-green-100 border-l-4 border-green-500 text-green-700"
                    : "mb-6 rounded-lg p-4 bg-red-100 border-l-4 border-red-500 text-red-700";
            }
        };


        const initializeFirebase = async () => {
            if (IS_PERSISTENCE_ENABLED) {
                try {
                    setLogLevel('Debug'); // Good for development, consider removing/disabling for production
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    const analytics = getAnalytics(app); // Google Analytics is initialized here

                    // You might want to log a basic event to confirm Analytics is working, e.g.:
                    // analytics.logEvent('app_initialized'); 

                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth); // Your app signs in anonymously
                    }

                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            setupRealtimeListeners(); 
                        } else {
                            fallbackToNonPersistentMode();
                        }
                    });

                } catch (error) {
                    console.error("Firebase initialization or initial sign-in failed:", error);
                    fallbackToNonPersistentMode(); 
                }
            } else {
                fallbackToNonPersistentMode();
            }
        };

        const loadDefaultData = () => {
            if (menuItems.length === 0) { 
                menuItems = [
                    { id: 'hc1', name: 'Hot Espresso', price: 50, category: 'Hot Coffee', imageUrl: 'https://images.unsplash.com/photo-1541167760496-1628856ab22d?q=80&w=1937&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { id: 'hc3', name: 'Hot Cappuccino', price: 60, category: 'Hot Coffee', imageUrl: 'https://images.unsplash.com/photo-1579992357154-faf4b4c1db20?q=80&w=2000&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { id: 'ic4', name: 'Ice Latte', price: 70, category: 'Ice Coffee', imageUrl: 'https://images.unsplash.com/photo-1517436214343-a621250d1822?q=80&w=1964&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { id: 'fc5', name: 'Frappe Mocha', price: 80, category: 'Frappe Coffee', imageUrl: 'https://images.unsplash.com/photo-1576092042784-06798e9b46e8?q=80&w=1964&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { id: 't2', name: 'Green Tea Milk', price: 60, category: 'Tea', imageUrl: 'https://images.unsplash.com/photo-1582200251846-5f096277b0c3?q=80&w=1935&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { id: 's1', name: 'Coconut Smoothie', price: 80, category: 'Smoothie', imageUrl: 'https://images.unsplash.com/photo-1502741338009-bec62d5d3ec6?q=80&w=1974&auto=format&fit=crop&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D' },
                    { id: 'top1', name: 'Strawberry Topping', price: 10, category: 'Topping', imageUrl: '' },
                ].map(item => ({ ...item, price: parseFloat(item.price).toFixed(2) })); 
            }
            orders = JSON.parse(sessionStorage.getItem('sessionOrders')) || [];
        };

        const setupRealtimeListeners = () => {
            // 1. Menu Items Listener
            const menuQ = query(getMenuCollection(), orderBy("name"));
            onSnapshot(menuQ, (snapshot) => {
                menuItems = snapshot.docs.map(doc => ({ 
                    id: doc.id, 
                    ...doc.data(), 
                    price: parseFloat(doc.data().price).toFixed(2)
                }));
                renderApp(); 
            }, (error) => {
                console.error("Error listening to menu:", error);
            });

            // 2. Orders Listener 
            const ordersQ = query(getOrdersCollection(), orderBy("timestamp", "desc"), limit(20));
            onSnapshot(ordersQ, (snapshot) => {
                orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (isAdmin) renderAdminDashboard();
            }, (error) => {
                console.error("Error listening to orders:", error);
            });
        };

        // --- RENDERING LOGIC ---

        const renderApp = () => {
            const mainContent = document.getElementById('main-content');
            mainContent.innerHTML = '';
            
            if (isAdmin) {
                renderAdminDashboard(mainContent);
            } else {
                renderCustomerView(mainContent);
                updateCartUI(); 
            }
            updateStatusMessage();
        };

        // --- CUSTOMER VIEW ---

        const renderCustomerView = (target) => {
            target.innerHTML = `
                <div class="flex flex-col lg:flex-row gap-8">
                    <!-- Menu List -->
                    <div class="lg:w-3/5 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-3xl font-bold mb-6 phu-dark-text border-b phu-green-border pb-2">Our Menu</h2>
                        <div id="menu-list" class="space-y-4">
                            ${renderCustomerMenu()}
                        </div>
                    </div>

                    <!-- Cart/Order Panel -->
                    <div class="lg:w-2/5 sticky top-4">
                        <div class="phu-light-green-bg p-6 rounded-xl shadow-lg">
                            <h2 class="text-3xl font-bold mb-4 phu-dark-text">Your Order</h2>
                            <div id="cart-details" class="space-y-3">
                                <!-- Cart details loaded by renderCartDetails -->
                            </div>
                            
                            <!-- Fields for Name and Table -->
                            <div class="mt-6 space-y-3">
                                <div>
                                    <label for="customerName" class="block text-sm font-medium phu-dark-text">Your Name</label>
                                    <input type="text" id="customerName" placeholder="e.g., John D." required
                                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" value="${localStorage.getItem('customerName') || ''}">
                                </div>
                                <div>
                                    <label for="tableNumber" class="block text-sm font-medium phu-dark-text">Table Number</label>
                                    <input type="text" id="tableNumber" placeholder="e.g., T4 or Bar" required
                                           class="w-full p-2 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500" value="${localStorage.getItem('tableNumber') || ''}">
                                </div>
                            </div>

                            <button id="placeOrderButton" onclick="placeOrder()" class="w-full phu-green-bg hover:bg-emerald-700 text-white font-bold py-3 px-4 rounded-lg mt-6 shadow-md transition duration-150 ease-in-out">
                                Place Order
                            </button>
                        </div>
                        
                        <!-- Admin Login Link -->
                        <div class="mt-4 text-center">
                            <a href="#" onclick="showAdminLogin()" class="text-sm phu-green-text hover:text-emerald-800 font-medium">Staff / Admin Login</a>
                        </div>
                    </div>
                </div>
            `;
        };

        const renderCustomerMenu = () => {
            if (menuItems.length === 0) {
                return '<p class="text-gray-500">Menu is currently empty.</p>';
            }

            const categories = menuItems.reduce((acc, item) => {
                const category = item.category || 'Uncategorized';
                if (!acc[category]) acc[category] = [];
                acc[category].push(item);
                return acc;
            }, {});

            let html = '';
            for (const category in categories) {
                html += `<h3 class="text-2xl font-semibold mt-6 mb-3 phu-dark-text">${category}</h3>`;
                categories[category].forEach(item => {
                    const imageUrl = item.imageUrl && item.imageUrl.trim() !== '' ? item.imageUrl : getPlaceholderImageUrl(item.name);
                    
                    html += `
                        <div class="menu-item flex justify-between items-center p-4 bg-white border border-gray-200 rounded-lg shadow-sm">
                            
                            <div class="flex items-center space-x-4">
                                <!-- Item Image with Fallback -->
                                <img src="${imageUrl}" 
                                    onerror="this.onerror=null; this.src='${getPlaceholderImageUrl('No Image')}'; this.style.border='1px solid #9ca3af';"
                                    alt="${item.name}" 
                                    class="w-16 h-16 object-cover rounded-lg shadow phu-green-border border-2"
                                />

                                <div>
                                    <p class="text-lg font-semibold phu-dark-text">${item.name}</p>
                                    <p class="text-gray-500">$${item.price}</p>
                                </div>
                            </div>
                            
                            <button onclick="addToCart('${item.id}', '${item.name}', ${item.price})" 
                                class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-full text-sm shadow-md transition duration-150">
                                Add
                            </button>
                        </div>
                    `;
                });
            }
            return html;
        };

        const renderCartDetails = () => {
            const items = Object.values(userCart);
            if (items.length === 0) {
                return '<p class="text-gray-500 italic">Your cart is empty. Add some delicious items!</p>';
            }

            let html = '<ul class="divide-y divide-gray-200">';
            items.forEach(item => {
                html += `
                    <li class="flex justify-between items-center py-2">
                        <div class="flex-grow">
                            <span class="font-medium phu-dark-text">${item.quantity}x ${item.name}</span>
                            <span class="text-sm text-gray-500 ml-2">(${(item.price * item.quantity).toFixed(2)})</span>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="updateCartQuantity('${item.id}', 1)" class="text-green-500 hover:text-green-700 text-lg font-bold w-6 h-6 rounded-full border border-green-500 leading-none">+</button>
                            <button onclick="updateCartQuantity('${item.id}', -1)" class="text-red-500 hover:text-red-700 text-lg font-bold w-6 h-6 rounded-full border border-red-500 leading-none">-</button>
                        </div>
                    </li>
                `;
            });
            html += '</ul>';
            html += `<p class="font-bold text-xl mt-4 border-t pt-2 flex justify-between phu-dark-text">Total: <span class="phu-green-text">$${calculateCartTotal().toFixed(2)}</span></p>`;
            return html;
        };

        // --- CART LOGIC ---

        window.addToCart = (id, name, price) => {
            const numPrice = parseFloat(price);
            if (userCart[id]) {
                userCart[id].quantity += 1;
            } else {
                userCart[id] = { id, name, price: numPrice, quantity: 1 }; 
            }
            updateCartUI();
        };

        window.updateCartQuantity = (id, change) => {
            if (userCart[id]) {
                userCart[id].quantity += change;
                if (userCart[id].quantity <= 0) {
                    delete userCart[id];
                }
            }
            updateCartUI();
        };

        const calculateCartTotal = () => {
            return Object.values(userCart).reduce((total, item) => total + (item.price * item.quantity), 0);
        };

        const updateCartUI = () => {
            localStorage.setItem('userCart', JSON.stringify(userCart));
            
            const cartDetails = document.getElementById('cart-details');
            const orderButton = document.getElementById('placeOrderButton');

            if (cartDetails) {
                cartDetails.innerHTML = renderCartDetails();
            }
            
            if (orderButton) {
                orderButton.textContent = `Place Order ($${calculateCartTotal().toFixed(2)})`;
                orderButton.disabled = calculateCartTotal() === 0;
                orderButton.classList.toggle('opacity-50', orderButton.disabled);
                orderButton.classList.toggle('hover:bg-emerald-700', !orderButton.disabled); 
            }
        };

        // --- ORDER LOGIC ---

        window.placeOrder = async () => {
            const customerName = document.getElementById('customerName')?.value.trim();
            const tableNumber = document.getElementById('tableNumber')?.value.trim();

            if (Object.keys(userCart).length === 0) {
                showModal('Order Failed', 'Your cart is empty. Please add items before placing an order.', 'Dismiss');
                return;
            }

            if (!customerName || !tableNumber) {
                showModal('Order Failed', 'Please enter your **Name** and **Table Number** to place the order.', 'Dismiss');
                return;
            }

            localStorage.setItem('customerName', customerName);
            localStorage.setItem('tableNumber', tableNumber);

            const total = calculateCartTotal();
            const orderData = {
                items: Object.values(userCart).map(item => ({
                    id: item.id,
                    name: item.name,
                    price: parseFloat(item.price).toFixed(2),
                    quantity: item.quantity
                })),
                total: total,
                userId: userId,
                customerName: customerName, 
                tableNumber: tableNumber,   
                timestamp: IS_PERSISTENCE_ENABLED ? serverTimestamp() : new Date().toISOString(),
                status: 'Pending'
            };

            if (IS_PERSISTENCE_ENABLED) {
                try {
                    await addDoc(getOrdersCollection(), orderData);
                    userCart = {};
                    updateCartUI();
                    showModal('Order Placed!', `Your order for $${total.toFixed(2)} has been successfully placed (Table: ${tableNumber}).`, 'Thank you!');
                } catch (error) {
                    console.error("Error placing order to Firestore:", error);
                    showModal('Error', 'Failed to place order to database. Please check console for details.', 'Close');
                }
            } else {
                const orderId = 'sess_' + Date.now();
                orders.unshift({ ...orderData, id: orderId }); 
                sessionStorage.setItem('sessionOrders', JSON.stringify(orders));
                userCart = {};
                updateCartUI();
                showModal('Order Placed! (Session Only)', `Your order for $${total.toFixed(2)} has been recorded in this session (Table: ${tableNumber}).`, 'Got it');
                if (isAdmin) renderAdminDashboard();
            }
        };
        
        // --- ADMIN ORDER MANAGEMENT ---

        window.updateOrderStatus = async (orderId, newStatus) => {
            const orderIndex = orders.findIndex(o => o.id === orderId);
            if (orderIndex === -1) {
                showModal('Error', 'Order not found.', 'Close');
                return;
            }
            
            if (IS_PERSISTENCE_ENABLED) {
                try {
                    const orderRef = doc(getOrdersCollection(), orderId);
                    await setDoc(orderRef, { status: newStatus, modifiedAt: serverTimestamp() }, { merge: true });
                    // Real-time listener will handle the UI update
                } catch (error) {
                    console.error(`Error updating order ${orderId} status to ${newStatus}:`, error);
                    showModal('Error', `Failed to update order status: ${error.message}`, 'Close');
                }
            } else {
                // Non-persistent update
                orders[orderIndex].status = newStatus;
                sessionStorage.setItem('sessionOrders', JSON.stringify(orders));
                renderAdminDashboard(); // Manual refresh
            }
        };

        // --- ADMIN LOGIN & DASHBOARD ---

        window.showAdminLogin = () => {
            showModal('Admin Login', `
                <p class="mb-4 text-gray-700">Enter the admin password to access the menu editor and order management dashboard.</p>
                <input type="password" id="adminPassword" placeholder="Admin Password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500">
                <p class="mt-2 text-sm text-red-500" id="loginError"></p>
                <div class="flex justify-end space-x-3 mt-4">
                    <button onclick="hideModal()" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-150">Cancel</button>
                    <button onclick="attemptAdminLogin()" class="px-4 py-2 phu-green-bg text-white font-semibold rounded-lg hover:bg-emerald-700 transition duration-150">Log In</button>
                </div>
            `, null, false);
        };

        window.attemptAdminLogin = () => {
            const password = document.getElementById('adminPassword').value;
            const errorElement = document.getElementById('loginError');

            if (password === ADMIN_PASSWORD) {
                isAdmin = true;
                hideModal();
                renderApp();
            } else {
                errorElement.textContent = 'Invalid password.';
            }
        };

        window.logoutAdmin = () => {
            isAdmin = false;
            editingItemId = null;
            renderApp();
        };

        const renderAdminDashboard = (target) => {
            target = target || document.getElementById('main-content');
            target.innerHTML = `
                <div class="phu-green-bg p-6 rounded-xl shadow-xl mb-8 flex justify-between items-center">
                    <h2 class="text-3xl font-bold text-white">Order & Menu Admin</h2>
                    <button onclick="logoutAdmin()" class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150">Log Out</button>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Menu Editor Panel (Left Column) -->
                    <div class="lg:col-span-1">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 phu-dark-text border-b phu-green-border pb-2">Menu Editor</h3>
                            <div id="menu-editor">
                                ${renderAdminMenuEditor()}
                            </div>
                            <div class="mt-8">
                                <h4 class="text-xl font-semibold mb-3 phu-dark-text">Current Menu Items (${menuItems.length})</h4>
                                <div class="space-y-3" id="admin-menu-list" style="max-height: 400px; overflow-y: auto;">
                                    ${renderAdminMenu()}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Orders Panel (Right Columns) -->
                    <div class="lg:col-span-2">
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-2xl font-bold mb-4 phu-dark-text border-b phu-green-border pb-2">Recent Orders (${orders.length})</h3>
                            <div id="orders-list" class="space-y-4 max-h-[80vh] overflow-y-auto">
                                ${renderAdminOrders()}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };
        
        const renderAdminMenuEditor = () => {
            let item = { name: '', price: '', category: 'Hot Coffee', imageUrl: '' };
            let buttonText = 'Add New Item';
            if (editingItemId) {
                item = menuItems.find(i => i.id === editingItemId) || item;
                item.price = parseFloat(item.price).toFixed(2); 
                buttonText = 'Save Changes';
            }

            return `
                <form id="menu-form" onsubmit="event.preventDefault(); saveMenuItem(event)" class="space-y-4 p-4 border phu-green-border rounded-lg phu-light-green-bg">
                    <h4 class="text-xl font-bold phu-green-text">${editingItemId ? 'Editing Item: ' + item.name : 'Add New Menu Item'}</h4>
                    <div>
                        <label for="itemName" class="block text-sm font-medium phu-dark-text">Name</label>
                        <input type="text" id="itemName" value="${item.name}" required class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="itemPrice" class="block text-sm font-medium phu-dark-text">Price ($)</label>
                        <input type="number" id="itemPrice" value="${item.price}" step="0.01" min="0.01" required class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    <div>
                        <label for="itemImageUrl" class="block text-sm font-medium phu-dark-text">Image URL (Optional)</label>
                        <input type="url" id="itemImageUrl" value="${item.imageUrl}" placeholder="e.g., https://unsplash.com/coffee.jpg" class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                    </div>
                    
                    <div>
                        <label for="itemCategory" class="block text-sm font-medium phu-dark-text">Category</label>
                        <select id="itemCategory" required class="mt-1 w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                            <option value="Hot Coffee" ${item.category === 'Hot Coffee' ? 'selected' : ''}>Hot Coffee</option>
                            <option value="Ice Coffee" ${item.category === 'Ice Coffee' ? 'selected' : ''}>Ice Coffee</option>
                            <option value="Frappe Coffee" ${item.category === 'Frappe Coffee' ? 'selected' : ''}>Frappe Coffee</option>
                            <option value="Tea" ${item.category === 'Tea' ? 'selected' : ''}>Tea</option>
                            <option value="Smoothie" ${item.category === 'Smoothie' ? 'selected' : ''}>Smoothie</option>
                            <option value="Topping" ${item.category === 'Topping' ? 'selected' : ''}>Topping</option>
                            <option value="Other" ${item.category === 'Other' ? 'selected' : ''}>Other</option>
                        </select>
                    </div>
                    <div class="flex justify-end space-x-2">
                        ${editingItemId ? `
                            <button type="button" onclick="cancelEdit()" class="px-4 py-2 bg-gray-300 text-gray-800 font-semibold rounded-lg hover:bg-gray-400 transition duration-150">Cancel Edit</button>
                        ` : ''}
                        <button type="submit" class="px-4 py-2 phu-green-bg text-white font-semibold rounded-lg hover:bg-emerald-700 transition duration-150 shadow-md">
                            ${buttonText}
                        </button>
                    </div>
                </form>
            `;
        };

        const renderAdminMenu = () => {
            if (menuItems.length === 0) {
                return '<p class="text-gray-500 italic">No menu items added yet.</p>';
            }

            let html = '<div class="space-y-2">';
            menuItems.forEach(item => {
                const imageUrl = item.imageUrl && item.imageUrl.trim() !== '' ? item.imageUrl : getPlaceholderImageUrl(item.name);

                html += `
                    <div class="flex items-center justify-between p-3 bg-white border border-gray-200 rounded-lg shadow-sm">
                        <div class="flex items-center space-x-3">
                            <img src="${imageUrl}" 
                                onerror="this.onerror=null; this.src='${getPlaceholderImageUrl('No Pic')}'"
                                alt="Pic" 
                                class="w-8 h-8 object-cover rounded-full"
                            />
                            <div class="flex-grow">
                                <p class="font-semibold phu-dark-text">${item.name} <span class="text-sm font-normal text-gray-500 ml-2">(${item.category})</span></p>
                                <p class="text-sm phu-green-text font-mono">$${item.price}</p>
                            </div>
                        </div>
                        <div class="flex space-x-2 admin-controls">
                            <button onclick="editItem('${item.id}')" class="text-sm px-3 py-1 bg-blue-500 text-white font-medium rounded-md hover:bg-blue-600">Edit</button>
                            <button onclick="deleteMenuItem('${item.id}')" class="text-sm px-3 py-1 bg-red-500 text-white font-medium rounded-md hover:bg-red-600">Delete</button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        };
        
        const renderAdminOrders = () => {
            if (orders.length === 0) {
                return '<p class="text-gray-500 italic">No recent orders.</p>';
            }

            let html = '<div class="space-y-4">';
            orders.forEach(order => {
                const timestamp = order.timestamp instanceof Date ? order.timestamp : (order.timestamp && order.timestamp.toDate ? order.timestamp.toDate() : new Date());
                const timeString = timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                const statusClass = order.status ? `status-${order.status.toLowerCase()}` : 'status-pending';

                html += `
                    <div class="p-4 border border-gray-200 rounded-lg shadow-md bg-white">
                        <div class="flex justify-between items-center mb-2 border-b pb-2">
                            <p class="text-lg font-bold phu-dark-text">Order Total: $${order.total.toFixed(2)}</p>
                            <span class="text-sm font-medium px-3 py-1 rounded-full border ${statusClass}">${order.status || 'Pending'}</span>
                        </div>

                        <p class="text-base text-gray-800 font-semibold mb-1">
                            ðŸ‘¤ ${order.customerName || 'N/A'} (Table: ${order.tableNumber || 'N/A'})
                        </p>
                        <p class="text-xs text-gray-500 mb-3">Time: ${timeString}</p>

                        <ul class="list-disc list-inside text-sm phu-dark-text mb-4 bg-gray-50 p-3 rounded-lg">
                            ${(order.items || []).map(item => `<li>${item.quantity}x ${item.name} ($${item.price})</li>`).join('')}
                        </ul>

                        <!-- Action Buttons -->
                        <div class="flex space-x-2 justify-end">
                            ${order.status !== 'Approved' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'Approved')" 
                                    class="flex items-center px-4 py-2 bg-green-500 text-white font-semibold rounded-lg hover:bg-green-600 transition duration-150 text-sm">
                                    âœ” Approve
                                </button>
                            ` : ''}
                            ${order.status !== 'Rejected' ? `
                                <button onclick="updateOrderStatus('${order.id}', 'Rejected')" 
                                    class="flex items-center px-4 py-2 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition duration-150 text-sm">
                                    âœ– Reject
                                </button>
                            ` : ''}
                            ${(order.status === 'Approved' || order.status === 'Rejected') ? `
                                <button onclick="updateOrderStatus('${order.id}', 'Pending')" 
                                    class="flex items-center px-4 py-2 bg-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-400 transition duration-150 text-sm">
                                    âŸ² Revert
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        };

        // --- MENU EDITOR ACTIONS ---

        window.editItem = (id) => {
            const item = menuItems.find(i => i.id === id);
            if (!item) {
                console.error('Item not found for editing:', id);
                return;
            }

            editingItemId = id;
            document.getElementById('menu-editor').innerHTML = renderAdminMenuEditor();
            document.getElementById('menu-editor').scrollIntoView({ behavior: 'smooth' });
        };
        
        window.cancelEdit = () => {
            editingItemId = null;
            document.getElementById('menu-editor').innerHTML = renderAdminMenuEditor();
        };

        window.saveMenuItem = async (event) => {
            event.preventDefault();
            const name = document.getElementById('itemName').value.trim();
            const priceFloat = parseFloat(document.getElementById('itemPrice').value);
            const price = priceFloat.toFixed(2); 
            const category = document.getElementById('itemCategory').value;
            const imageUrl = document.getElementById('itemImageUrl').value.trim(); 
            
            const itemData = { name, price: price, category, imageUrl }; 
            const isEditing = editingItemId !== null;

            if (!name || isNaN(priceFloat) || priceFloat <= 0) {
                showModal('Error', 'Please provide a valid name and price greater than zero.', 'Close');
                return;
            }

            // THIS IS THE CODE THAT INTERACTS WITH FIRESTORE
            if (IS_PERSISTENCE_ENABLED) {
                try {
                    if (isEditing) {
                        const itemDocRef = doc(getMenuCollection(), editingItemId);
                        await setDoc(itemDocRef, itemData, { merge: true });
                    } else {
                        // This line is attempting to add a new document
                        await addDoc(getMenuCollection(), itemData);
                    }
                    
                    document.getElementById('menu-form').reset();
                    cancelEdit(); 
                } catch (error) {
                    console.error("Error saving menu item:", error);
                    showModal('Error', `Failed to save menu item to database. Details: ${error.message}`, 'Close');
                }
            } else {
                // Non-persistent mode update
                if (isEditing) {
                    const index = menuItems.findIndex(item => item.id === editingItemId);
                    if (index !== -1) {
                        menuItems[index] = { id: editingItemId, ...itemData };
                    }
                } else {
                    const newItem = { id: 'def_' + Date.now(), ...itemData };
                    menuItems.push(newItem);
                }
                
                document.getElementById('menu-form').reset();
                cancelEdit(); 
                renderAdminDashboard(); 
            }
        };

        window.deleteMenuItem = async (id) => {
            if (IS_PERSISTENCE_ENABLED) {
                try {
                    const itemDocRef = doc(getMenuCollection(), id);
                    await deleteDoc(itemDocRef);
                } catch (error) {
                    console.error("Error deleting menu item:", error);
                    showModal('Error', `Failed to delete item. Details: ${error.message}`, 'Close');
                }
            } else {
                menuItems = menuItems.filter(item => item.id !== id);
                renderAdminDashboard(); 
            }
        };

        // --- MODAL UTILITY ---

        window.showModal = (title, bodyHtml, buttonText = 'Close', showFooter = true) => {
            const modalContainer = document.getElementById('modal-container');
            const modalContent = document.getElementById('modal-content');
            
            let footerHtml = '';
            if (showFooter) {
                footerHtml = `<div class="mt-4 pt-4 border-t flex justify-end">
                    <button onclick="hideModal()" class="px-4 py-2 phu-green-bg text-white font-semibold rounded-lg hover:bg-emerald-700 transition duration-150">${buttonText}</button>
                </div>`;
            }

            modalContent.innerHTML = `
                <h3 class="2xl font-bold mb-3 phu-dark-text">${title}</h3>
                <div class="text-gray-700">${bodyHtml}</div>
                ${footerHtml}
            `;
            modalContainer.classList.remove('hidden');
            modalContainer.classList.add('flex');
        };

        window.hideModal = () => {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.classList.remove('flex');
            modalContainer.classList.add('hidden');
        };

        // --- ENTRY POINT ---
        window.onload = initializeFirebase;
    </script>

</body>
</html>
